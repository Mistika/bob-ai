function messageIn(e){var r=e.body;e.senderID;console.log("Message in: "+r+" ##########");var n=r.replace(/\?/,".");n=r.split(".");for(var o=0;o<n.length;o++)learnWords(removeNonWords(n[o].split(" ")).reverse());return shouldRespond(r)?messageOut(r,e):!1}function messageOut(e,r){for(var n=e.split(" ").reverse(),o=0;o<n.length;o++)-1==wordIndex(n[o])&&(n.splice(o,1),o--);var t=knowResponses(e)||command(e,r);return t=t||genMessage(n),console.log("Message out: "+t),swearFilter(t)}function knowResponses(e){e=e.replace(/[\.\?!,']/g,""),e=e.replace(/bob| bob|bob | bob |/gi,"");for(var n=0;n<known.length;n++)if(includes(known[n][0],e))return known[n][1][r(known[n][1])];return!1}function command(e,n){var o=e.split(" "),t=e.replace(/bob /i,"");if(!o[0].match(/bob/i)||o.length<2)return!1;if(o[1].match(/calc|calculate|math|evaluate/i)){for(var a=[],i=0;i<o.length;i++)i>1&&a.push(o[i]);a=a.join(" ");var s=math.eval(a);return s.toString()}if(e.match(/how many words|words do you|do you know|how smart|what words/gi))return"I know "+db.w.length+" words.";if(e.replace(/bob /i,"").match(/what can|you do|your abilities|you able/i)){var u=['I can convert currency. Try "Bob convert USD to CAD".','I can calculate stuff. Try "Bob calc 5 * sin(3) / 2"','I can tell you how many words I know. Try "Bob how many words do you know?"','I can countdown to a holiday. Try "Bob how many days until christmas?"'];return u[r(u)]}if(t.match(/what version|your version/i))return"I am version "+version;if(t.match(/random number/i)){if(t.match(/pick a random number between/i)){var c=o[6],l=o[8];return Math.floor(Math.random()*(l-c)+c).toString()}return Math.random().toString()}if(t.match(/what time|the time|what day|what year|what month/i))return new Date;if(t.match(/how many days|days until|how long|long til|long until|when is/i)){var d={christmas:359,christmas_eve:358,halloween:304,new_years:1,new_years_eve:365,valentines_day:45},h=o[o.length-1].toLowerCase().replace(/\?/gi,""),f=new Date,w=new Date(f.getFullYear(),0,0),g=Math.floor((f-w)/1e3*60*60*24);if(d[h])return d[h]<g&&(g-=365),"There are "+(d[h]-g+1)+" days until "+h}if(e.match(/how many times/i))return wordIndex(o[o.length-1])>-1?db.w[wordIndex(o[o.length-1])].count+" times.":!1;if(t.match(/show[\s\S]*info for/i))return JSON.stringify(db.w[wordIndex(o[o.length-1])]);if(t.match(/remind me [\s\S]* in/i)){var m=t.replace(/remind me to|remind me|in[0-9]*seconds|in[\s\S]*hours|in[\s\S]*minutes/gi,""),v=parseInt(o[o.length-2]),p=o[o.length-1],b=0;if(p.match(/second/i))b=1e3;else if(p.match(/minute/i))b=6e4;else{if(!p.match(/hour/i))return"How long is a "+p+"?";b=36e5}return setTimeout(function(){api_g.sendMessage(m,n.threadID)},v*b),"Reminder set!"}if(t.match(/convert [\s\S]* to [\s\S]*/i)&&o.length>4){var y=o[4],I=o[2];if(!currency.rates[y])return"I do not know the currency "+y;if(!currency.rates[I])return"I do not know the currency "+I;var S=1/currency.rates[y];return"The rate is "+currency.rates[I]*S+" "+I+" to 1 "+y}if(t.match(/write db\.w your_password/))return fs.writeFile("db.txt",JSON.stringify(db.w,null,"	"),function(e){return e?console.log(e):void console.log("db.w saved to file!")}),"ok";if(t.match(/list [\s\S]*/)&&o.length>2&&o[2].match(/currencies|currency|money/i)){var s="";for(var k in currency.rates)s+=k+" ";return"Known currencies: "+s+"."}return e.match(/who am i/i)?sender:!1}function shouldRespond(e){return e.match(/bob|everyone/gi)?!0:!1}function removeNonWords(e){for(var r=0;r<e.length;r++)includes(invalid_words,e[r])&&(e.splice(r,1),r--);return e}function includes(e,r){for(var n=0;n<e.length;n++)if(e[n]==r)return!0;return!1}function r(e){return Math.floor(Math.random()*e.length)}function wordIndex(e){for(var r=0;r<db.w.length;r++)if(db.w[r].word===e)return r;return-1}function learnWords(e){if(e.length<1)return 0;for(var r=0,n=e.length;n>r;r++){var o=wordIndex(e[r]);if(0>o){var t={word:e[r],after:[],count:0},a=[];db.w.push(t),o=wordIndex(e[r])}db.w[o].count++;for(var a=[],i=0;3>i;i++)r>i?a.push(wordIndex(e[r-(i+1)])):r==i&&a.push(-1);db.w[o].after.push(a)}}function genMessage(e){var r=findMainWords(e);console.log("Important words: "+r);for(var n=wordIndex(r[0]),o=db.w[n].word,t=Math.floor(15*Math.random()+25),a=[n],i=[[],[],[]],s=0;t>s;s++)db.w[n].after[0].length>0&&(i[0]=db.w[n].after,s>1&&(i[1]=db.w[a[a.length-2]].after,s>2&&(i[2]=db.w[a[a.length-3]].after)),n=pickNext(i[0],i[1],i[2],[a[a.length-1],a[a.length-2]||!1],r),a.push(n),n>-1?o+=" "+db.w[n].word:s=t);return o+="."}function pickNext(e,n,o,t,a){for(var i=[],s=0;s<e.length;s++)i.push(e[s][0]);for(var u=[],s=0;s<n.length;n++)t[0]==n[s][0]&&u.push(n[s][1]);for(var c=[],s=0;s<o.length;s++)t[0]==o[s][1]&&t[1]==o[s][0]&&c.push(o[s][2]);return console.log("Words matching topic: "+compare(i,a)),c.length>0?(console.log("C"),c[r(c)]):u.length>0?(console.log("B"),u[r(u)]):i.length>0?(console.log("A"),i[r(i)]):db.w[r(db.w)].word}function findMainWords(e,n){for(var o=[],t=avgCount(),a=0;a<e.length;a++)db.w[wordIndex(e[a])].count<100*t&&!e[a].match(/bob/)&&o.push(e[a]);return o=o.sort(function(e,r){return r.length-e.length}),o.length>0?o:e[r(e)]}function compare(e,r){for(var n=0;n<e.length;n++)if(includes(r,e[n]))return n;return!1}function justLearn(e){var r=e.replace(/\?/,".");r=e.split(".");for(var n=0;n<r.length;n++)learnWords(removeNonWords(r[n].split(" ")).reverse());console.log("Words learned!")}function avgCount(){for(var e=0,r=0;r<db.w.length;r++)e+=db.w[r].count;return e/=db.w.length}function isSpecial(e,r){if(-1==wordIndex(e))return!1;var n=db.w[wordIndex(e)].count;return n>r+1}function mode(e){var r,n={},o=0;return e.forEach(function(e){n[e]=(n[e]||0)+1,o<n[e]&&(o=n[e],r=e)}),+r}function median(e){e.sort(function(e,r){return e-r});var r=Math.floor(e.length/2);return e.length%2?e[r]:(e[r-1]+e[r])/2}function updateCurrency(){request("http://api.fixer.io/latest",function(e,r,n){e||200!=r.statusCode||(currency=JSON.parse(n))}),console.log("Currency updated!")}function swearFilter(e){return typeof e!=String&&(e=e.toString()),e.replace(/fuck|shit|damn|porn|dick|ass|slut|cunt/gi,"****")}var login=require("facebook-chat-api"),fs=require("fs"),math=require("mathjs"),request=require("request"),http=require("http"),version="1.4.0",db={w:[]},api_g,known=[[["Hi","hi","hello","Hello"],["Hi","Hello"]],[["Hey","hey"],["Hey","Sup","What's up?"]],[["lol","Lol"],["lol","lol!","haha","hehe","ha!"]],[["sup","Sup"],["Nothing, you?","nm, wbu?","Not much what about you?","Not much. You?"]],[["Hows it going","hows it going","How are you","how are you"],["Great! You?","good you?","Good. How about you?"]]],invalid_words=[""," "],currency={};updateCurrency(),db.w=JSON.parse(fs.readFileSync("/home/nathan/Documents/f/db.txt").toString());var download=function(e,r,n){request.head(e,function(o,t,a){request(e).pipe(fs.createWriteStream(r)).on("close",n)})};login({email:"email@example.com",password:"password"},function(e,r){if(e)return console.error(e);api_g=r,r.setOptions({listenEvents:!0});var n=r.listen(function(e,o){if(e)return console.error(e);switch(o.type){case"message":if("/stop"===o.body)return r.sendMessage("Goodbye...",o.threadID),n();r.markAsRead(o.threadID,function(e){e&&console.log(e)});var t={body:messageIn(o)};r.sendMessage(t,o.threadID);break;case"event":console.log(o)}})});
